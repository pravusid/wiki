<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Go 동시성 | TIL wiki</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/wiki/assets/css/0.styles.28a8e502.css" as="style"><link rel="preload" href="/wiki/assets/js/app.36606fb6.js" as="script"><link rel="preload" href="/wiki/assets/js/2.05cc4ee4.js" as="script"><link rel="preload" href="/wiki/assets/js/71.8dff6073.js" as="script"><link rel="prefetch" href="/wiki/assets/js/10.c2c98ca8.js"><link rel="prefetch" href="/wiki/assets/js/100.1d863c96.js"><link rel="prefetch" href="/wiki/assets/js/101.2f438bcc.js"><link rel="prefetch" href="/wiki/assets/js/102.5f087bda.js"><link rel="prefetch" href="/wiki/assets/js/103.8a2b176a.js"><link rel="prefetch" href="/wiki/assets/js/104.b3aa0f91.js"><link rel="prefetch" href="/wiki/assets/js/105.714e4c3c.js"><link rel="prefetch" href="/wiki/assets/js/106.0b3ed459.js"><link rel="prefetch" href="/wiki/assets/js/107.54b0e6e2.js"><link rel="prefetch" href="/wiki/assets/js/108.f5112c1d.js"><link rel="prefetch" href="/wiki/assets/js/109.45c17bdc.js"><link rel="prefetch" href="/wiki/assets/js/11.90cbe306.js"><link rel="prefetch" href="/wiki/assets/js/110.d4ca0941.js"><link rel="prefetch" href="/wiki/assets/js/111.d0eb9466.js"><link rel="prefetch" href="/wiki/assets/js/112.d4edb2fb.js"><link rel="prefetch" href="/wiki/assets/js/113.2b583580.js"><link rel="prefetch" href="/wiki/assets/js/114.0c081caa.js"><link rel="prefetch" href="/wiki/assets/js/115.fd090ff6.js"><link rel="prefetch" href="/wiki/assets/js/116.d6c7cabc.js"><link rel="prefetch" href="/wiki/assets/js/117.3cce7929.js"><link rel="prefetch" href="/wiki/assets/js/118.415ef8ae.js"><link rel="prefetch" href="/wiki/assets/js/119.53179cf9.js"><link rel="prefetch" href="/wiki/assets/js/12.9740f195.js"><link rel="prefetch" href="/wiki/assets/js/120.b843a850.js"><link rel="prefetch" href="/wiki/assets/js/121.2f144b26.js"><link rel="prefetch" href="/wiki/assets/js/122.fdbb383e.js"><link rel="prefetch" href="/wiki/assets/js/123.85caa5d8.js"><link rel="prefetch" href="/wiki/assets/js/124.6c8b1960.js"><link rel="prefetch" href="/wiki/assets/js/125.36055b31.js"><link rel="prefetch" href="/wiki/assets/js/126.3452aec3.js"><link rel="prefetch" href="/wiki/assets/js/127.84abdbe6.js"><link rel="prefetch" href="/wiki/assets/js/128.46c8dc70.js"><link rel="prefetch" href="/wiki/assets/js/129.942fc82c.js"><link rel="prefetch" href="/wiki/assets/js/13.859753cd.js"><link rel="prefetch" href="/wiki/assets/js/130.f4d09988.js"><link rel="prefetch" href="/wiki/assets/js/131.555d59a3.js"><link rel="prefetch" href="/wiki/assets/js/132.0135c0f6.js"><link rel="prefetch" href="/wiki/assets/js/133.777c269e.js"><link rel="prefetch" href="/wiki/assets/js/134.bb5c14d8.js"><link rel="prefetch" href="/wiki/assets/js/135.70ea65a0.js"><link rel="prefetch" href="/wiki/assets/js/136.1a8a71bd.js"><link rel="prefetch" href="/wiki/assets/js/137.fbf347e8.js"><link rel="prefetch" href="/wiki/assets/js/138.e3552322.js"><link rel="prefetch" href="/wiki/assets/js/139.6f33e82e.js"><link rel="prefetch" href="/wiki/assets/js/14.c5dc23f3.js"><link rel="prefetch" href="/wiki/assets/js/140.16de4b52.js"><link rel="prefetch" href="/wiki/assets/js/141.79b52588.js"><link rel="prefetch" href="/wiki/assets/js/142.cc794dcb.js"><link rel="prefetch" href="/wiki/assets/js/143.8daf3dbb.js"><link rel="prefetch" href="/wiki/assets/js/144.cacb2ead.js"><link rel="prefetch" href="/wiki/assets/js/145.5729ac96.js"><link rel="prefetch" href="/wiki/assets/js/146.ec308c42.js"><link rel="prefetch" href="/wiki/assets/js/147.a59a1400.js"><link rel="prefetch" href="/wiki/assets/js/148.f8a12ab9.js"><link rel="prefetch" href="/wiki/assets/js/149.82893f63.js"><link rel="prefetch" href="/wiki/assets/js/15.7f50f7a2.js"><link rel="prefetch" href="/wiki/assets/js/150.8db59b4e.js"><link rel="prefetch" href="/wiki/assets/js/151.c7c418bb.js"><link rel="prefetch" href="/wiki/assets/js/152.810de28a.js"><link rel="prefetch" href="/wiki/assets/js/153.8dc64858.js"><link rel="prefetch" href="/wiki/assets/js/154.e2236cb6.js"><link rel="prefetch" href="/wiki/assets/js/155.b7401d2d.js"><link rel="prefetch" href="/wiki/assets/js/156.f038b24e.js"><link rel="prefetch" href="/wiki/assets/js/157.5141ffe3.js"><link rel="prefetch" href="/wiki/assets/js/158.187884e8.js"><link rel="prefetch" href="/wiki/assets/js/159.efe7f18d.js"><link rel="prefetch" href="/wiki/assets/js/16.153fa8d1.js"><link rel="prefetch" href="/wiki/assets/js/160.8f8f62a8.js"><link rel="prefetch" href="/wiki/assets/js/161.b0d29a7d.js"><link rel="prefetch" href="/wiki/assets/js/162.385e06d6.js"><link rel="prefetch" href="/wiki/assets/js/163.76b313d0.js"><link rel="prefetch" href="/wiki/assets/js/164.27c8f96f.js"><link rel="prefetch" href="/wiki/assets/js/165.3d94b23a.js"><link rel="prefetch" href="/wiki/assets/js/166.3bcf3db9.js"><link rel="prefetch" href="/wiki/assets/js/167.21a66261.js"><link rel="prefetch" href="/wiki/assets/js/168.1aecccd3.js"><link rel="prefetch" href="/wiki/assets/js/169.7c4c3541.js"><link rel="prefetch" href="/wiki/assets/js/17.af681efa.js"><link rel="prefetch" href="/wiki/assets/js/170.0608aa21.js"><link rel="prefetch" href="/wiki/assets/js/171.62dccae8.js"><link rel="prefetch" href="/wiki/assets/js/172.e5726f99.js"><link rel="prefetch" href="/wiki/assets/js/173.a65c0a1e.js"><link rel="prefetch" href="/wiki/assets/js/174.ef49c564.js"><link rel="prefetch" href="/wiki/assets/js/175.0a985c66.js"><link rel="prefetch" href="/wiki/assets/js/176.4803c960.js"><link rel="prefetch" href="/wiki/assets/js/177.46cd0f4d.js"><link rel="prefetch" href="/wiki/assets/js/178.830ce488.js"><link rel="prefetch" href="/wiki/assets/js/179.5a1f83c5.js"><link rel="prefetch" href="/wiki/assets/js/18.73907c72.js"><link rel="prefetch" href="/wiki/assets/js/180.067b0b34.js"><link rel="prefetch" href="/wiki/assets/js/181.82a55368.js"><link rel="prefetch" href="/wiki/assets/js/182.3d0a189b.js"><link rel="prefetch" href="/wiki/assets/js/183.1818bcba.js"><link rel="prefetch" href="/wiki/assets/js/184.9a0f5425.js"><link rel="prefetch" href="/wiki/assets/js/185.312f54b0.js"><link rel="prefetch" href="/wiki/assets/js/186.62168514.js"><link rel="prefetch" href="/wiki/assets/js/187.6e2366a6.js"><link rel="prefetch" href="/wiki/assets/js/188.65e67e72.js"><link rel="prefetch" href="/wiki/assets/js/189.8ac83556.js"><link rel="prefetch" href="/wiki/assets/js/19.6490ec74.js"><link rel="prefetch" href="/wiki/assets/js/190.ce5ddf9e.js"><link rel="prefetch" href="/wiki/assets/js/191.47fe13b1.js"><link rel="prefetch" href="/wiki/assets/js/192.eaf84940.js"><link rel="prefetch" href="/wiki/assets/js/193.c11bd480.js"><link rel="prefetch" href="/wiki/assets/js/194.0a3f6e3b.js"><link rel="prefetch" href="/wiki/assets/js/195.50924754.js"><link rel="prefetch" href="/wiki/assets/js/196.6d71f593.js"><link rel="prefetch" href="/wiki/assets/js/197.46631eb4.js"><link rel="prefetch" href="/wiki/assets/js/198.9f02b930.js"><link rel="prefetch" href="/wiki/assets/js/199.8ecd34b7.js"><link rel="prefetch" href="/wiki/assets/js/20.7aaef2ea.js"><link rel="prefetch" href="/wiki/assets/js/200.33beac0c.js"><link rel="prefetch" href="/wiki/assets/js/201.eb3ddea5.js"><link rel="prefetch" href="/wiki/assets/js/202.41388b27.js"><link rel="prefetch" href="/wiki/assets/js/203.aa587d7b.js"><link rel="prefetch" href="/wiki/assets/js/204.f5330975.js"><link rel="prefetch" href="/wiki/assets/js/205.aafe915c.js"><link rel="prefetch" href="/wiki/assets/js/206.89c78f30.js"><link rel="prefetch" href="/wiki/assets/js/207.6f09ea04.js"><link rel="prefetch" href="/wiki/assets/js/208.fda2005e.js"><link rel="prefetch" href="/wiki/assets/js/209.4eb401f0.js"><link rel="prefetch" href="/wiki/assets/js/21.a273efba.js"><link rel="prefetch" href="/wiki/assets/js/210.3478ae6f.js"><link rel="prefetch" href="/wiki/assets/js/211.79904cae.js"><link rel="prefetch" href="/wiki/assets/js/212.7fc026b2.js"><link rel="prefetch" href="/wiki/assets/js/213.cf8a9ac0.js"><link rel="prefetch" href="/wiki/assets/js/214.e97157eb.js"><link rel="prefetch" href="/wiki/assets/js/215.e89ab837.js"><link rel="prefetch" href="/wiki/assets/js/216.287918c6.js"><link rel="prefetch" href="/wiki/assets/js/217.a1c2bce6.js"><link rel="prefetch" href="/wiki/assets/js/218.f7f75dd8.js"><link rel="prefetch" href="/wiki/assets/js/219.c63d80a8.js"><link rel="prefetch" href="/wiki/assets/js/22.c3cedf26.js"><link rel="prefetch" href="/wiki/assets/js/220.34011dad.js"><link rel="prefetch" href="/wiki/assets/js/221.0a89975f.js"><link rel="prefetch" href="/wiki/assets/js/222.3f855f7e.js"><link rel="prefetch" href="/wiki/assets/js/223.1df2d46a.js"><link rel="prefetch" href="/wiki/assets/js/224.468209a5.js"><link rel="prefetch" href="/wiki/assets/js/225.eabc33d5.js"><link rel="prefetch" href="/wiki/assets/js/226.07d2ac6f.js"><link rel="prefetch" href="/wiki/assets/js/227.d1c9f747.js"><link rel="prefetch" href="/wiki/assets/js/228.d5160986.js"><link rel="prefetch" href="/wiki/assets/js/229.9ffb9df7.js"><link rel="prefetch" href="/wiki/assets/js/23.9eec096b.js"><link rel="prefetch" href="/wiki/assets/js/230.8a434820.js"><link rel="prefetch" href="/wiki/assets/js/231.c2310747.js"><link rel="prefetch" href="/wiki/assets/js/232.f6d28911.js"><link rel="prefetch" href="/wiki/assets/js/233.030a29ab.js"><link rel="prefetch" href="/wiki/assets/js/234.21ed2c91.js"><link rel="prefetch" href="/wiki/assets/js/235.088a9793.js"><link rel="prefetch" href="/wiki/assets/js/236.84db8306.js"><link rel="prefetch" href="/wiki/assets/js/237.4e048104.js"><link rel="prefetch" href="/wiki/assets/js/238.16e6e595.js"><link rel="prefetch" href="/wiki/assets/js/239.748deb99.js"><link rel="prefetch" href="/wiki/assets/js/24.5c0d1770.js"><link rel="prefetch" href="/wiki/assets/js/240.6041248b.js"><link rel="prefetch" href="/wiki/assets/js/241.e20bb07d.js"><link rel="prefetch" href="/wiki/assets/js/242.a358412f.js"><link rel="prefetch" href="/wiki/assets/js/243.f5e79fc2.js"><link rel="prefetch" href="/wiki/assets/js/244.91462595.js"><link rel="prefetch" href="/wiki/assets/js/245.4d2feb30.js"><link rel="prefetch" href="/wiki/assets/js/246.b2e57c44.js"><link rel="prefetch" href="/wiki/assets/js/247.01936bba.js"><link rel="prefetch" href="/wiki/assets/js/248.9fa211e6.js"><link rel="prefetch" href="/wiki/assets/js/249.d1e34d83.js"><link rel="prefetch" href="/wiki/assets/js/25.28df5e10.js"><link rel="prefetch" href="/wiki/assets/js/250.77c595aa.js"><link rel="prefetch" href="/wiki/assets/js/251.fd70adc5.js"><link rel="prefetch" href="/wiki/assets/js/252.64dc3273.js"><link rel="prefetch" href="/wiki/assets/js/253.9fecc32c.js"><link rel="prefetch" href="/wiki/assets/js/254.990c88fc.js"><link rel="prefetch" href="/wiki/assets/js/255.bc7790a6.js"><link rel="prefetch" href="/wiki/assets/js/256.827e0eed.js"><link rel="prefetch" href="/wiki/assets/js/257.e67ee327.js"><link rel="prefetch" href="/wiki/assets/js/258.fc4ca485.js"><link rel="prefetch" href="/wiki/assets/js/259.7d1fcd97.js"><link rel="prefetch" href="/wiki/assets/js/26.3b7b3987.js"><link rel="prefetch" href="/wiki/assets/js/260.a8266a8f.js"><link rel="prefetch" href="/wiki/assets/js/261.fb51a41d.js"><link rel="prefetch" href="/wiki/assets/js/262.7c7b6be4.js"><link rel="prefetch" href="/wiki/assets/js/263.29eb2bad.js"><link rel="prefetch" href="/wiki/assets/js/264.f930649a.js"><link rel="prefetch" href="/wiki/assets/js/265.a9a24199.js"><link rel="prefetch" href="/wiki/assets/js/266.ce62951e.js"><link rel="prefetch" href="/wiki/assets/js/267.3be501e2.js"><link rel="prefetch" href="/wiki/assets/js/268.76004529.js"><link rel="prefetch" href="/wiki/assets/js/269.a3a32936.js"><link rel="prefetch" href="/wiki/assets/js/27.14d9af13.js"><link rel="prefetch" href="/wiki/assets/js/270.a6ca7428.js"><link rel="prefetch" href="/wiki/assets/js/271.e7f64414.js"><link rel="prefetch" href="/wiki/assets/js/272.6a37298d.js"><link rel="prefetch" href="/wiki/assets/js/273.a6bc0c09.js"><link rel="prefetch" href="/wiki/assets/js/274.f1c8fb6f.js"><link rel="prefetch" href="/wiki/assets/js/275.1bb80077.js"><link rel="prefetch" href="/wiki/assets/js/276.e8bafb59.js"><link rel="prefetch" href="/wiki/assets/js/277.07b0daee.js"><link rel="prefetch" href="/wiki/assets/js/278.ed8279da.js"><link rel="prefetch" href="/wiki/assets/js/279.71329331.js"><link rel="prefetch" href="/wiki/assets/js/28.901729ab.js"><link rel="prefetch" href="/wiki/assets/js/280.b08e49bf.js"><link rel="prefetch" href="/wiki/assets/js/281.f1f50871.js"><link rel="prefetch" href="/wiki/assets/js/282.1c49cddd.js"><link rel="prefetch" href="/wiki/assets/js/283.7cff681e.js"><link rel="prefetch" href="/wiki/assets/js/284.94681067.js"><link rel="prefetch" href="/wiki/assets/js/285.2e2e098f.js"><link rel="prefetch" href="/wiki/assets/js/286.38b5be77.js"><link rel="prefetch" href="/wiki/assets/js/287.5c55fe1e.js"><link rel="prefetch" href="/wiki/assets/js/288.69b745d0.js"><link rel="prefetch" href="/wiki/assets/js/289.2434062e.js"><link rel="prefetch" href="/wiki/assets/js/29.840af849.js"><link rel="prefetch" href="/wiki/assets/js/290.a0882e9d.js"><link rel="prefetch" href="/wiki/assets/js/291.614ee588.js"><link rel="prefetch" href="/wiki/assets/js/292.3ceb3217.js"><link rel="prefetch" href="/wiki/assets/js/293.02c17ffa.js"><link rel="prefetch" href="/wiki/assets/js/294.c3b57264.js"><link rel="prefetch" href="/wiki/assets/js/295.c81feb5e.js"><link rel="prefetch" href="/wiki/assets/js/3.20c07a24.js"><link rel="prefetch" href="/wiki/assets/js/30.35de8e2b.js"><link rel="prefetch" href="/wiki/assets/js/31.6b286ac7.js"><link rel="prefetch" href="/wiki/assets/js/32.ae4c36e6.js"><link rel="prefetch" href="/wiki/assets/js/33.3f2f5ef1.js"><link rel="prefetch" href="/wiki/assets/js/34.e7d74b83.js"><link rel="prefetch" href="/wiki/assets/js/35.f5da1e56.js"><link rel="prefetch" href="/wiki/assets/js/36.b94b4e54.js"><link rel="prefetch" href="/wiki/assets/js/37.a0abcb8f.js"><link rel="prefetch" href="/wiki/assets/js/38.7a6c7a7a.js"><link rel="prefetch" href="/wiki/assets/js/39.f798901d.js"><link rel="prefetch" href="/wiki/assets/js/4.70e730be.js"><link rel="prefetch" href="/wiki/assets/js/40.86ed65c7.js"><link rel="prefetch" href="/wiki/assets/js/41.f53f8a7b.js"><link rel="prefetch" href="/wiki/assets/js/42.89c0d9aa.js"><link rel="prefetch" href="/wiki/assets/js/43.7abbb800.js"><link rel="prefetch" href="/wiki/assets/js/44.10d59381.js"><link rel="prefetch" href="/wiki/assets/js/45.71bc2a23.js"><link rel="prefetch" href="/wiki/assets/js/46.08c1a6ef.js"><link rel="prefetch" href="/wiki/assets/js/47.e59ec510.js"><link rel="prefetch" href="/wiki/assets/js/48.cc5614ec.js"><link rel="prefetch" href="/wiki/assets/js/49.a89ad9c4.js"><link rel="prefetch" href="/wiki/assets/js/5.611833a9.js"><link rel="prefetch" href="/wiki/assets/js/50.2fa98a7e.js"><link rel="prefetch" href="/wiki/assets/js/51.c9267d4c.js"><link rel="prefetch" href="/wiki/assets/js/52.5603adc6.js"><link rel="prefetch" href="/wiki/assets/js/53.720885c3.js"><link rel="prefetch" href="/wiki/assets/js/54.c5253b58.js"><link rel="prefetch" href="/wiki/assets/js/55.b6455032.js"><link rel="prefetch" href="/wiki/assets/js/56.c582ce3f.js"><link rel="prefetch" href="/wiki/assets/js/57.625163de.js"><link rel="prefetch" href="/wiki/assets/js/58.932cc397.js"><link rel="prefetch" href="/wiki/assets/js/59.a73ea388.js"><link rel="prefetch" href="/wiki/assets/js/6.9c057f2c.js"><link rel="prefetch" href="/wiki/assets/js/60.dee11cbd.js"><link rel="prefetch" href="/wiki/assets/js/61.e575143c.js"><link rel="prefetch" href="/wiki/assets/js/62.045f27d0.js"><link rel="prefetch" href="/wiki/assets/js/63.cff5f1b5.js"><link rel="prefetch" href="/wiki/assets/js/64.3078743b.js"><link rel="prefetch" href="/wiki/assets/js/65.c979cbfb.js"><link rel="prefetch" href="/wiki/assets/js/66.c23bb325.js"><link rel="prefetch" href="/wiki/assets/js/67.d5baba3b.js"><link rel="prefetch" href="/wiki/assets/js/68.8947e930.js"><link rel="prefetch" href="/wiki/assets/js/69.8f5fe2db.js"><link rel="prefetch" href="/wiki/assets/js/7.b48a85c8.js"><link rel="prefetch" href="/wiki/assets/js/70.1bffff80.js"><link rel="prefetch" href="/wiki/assets/js/72.339537b2.js"><link rel="prefetch" href="/wiki/assets/js/73.98e618ac.js"><link rel="prefetch" href="/wiki/assets/js/74.4875c884.js"><link rel="prefetch" href="/wiki/assets/js/75.15939e4a.js"><link rel="prefetch" href="/wiki/assets/js/76.04172399.js"><link rel="prefetch" href="/wiki/assets/js/77.e986f4e0.js"><link rel="prefetch" href="/wiki/assets/js/78.7633297a.js"><link rel="prefetch" href="/wiki/assets/js/79.3c1e2cfb.js"><link rel="prefetch" href="/wiki/assets/js/8.91d1f36f.js"><link rel="prefetch" href="/wiki/assets/js/80.294d135d.js"><link rel="prefetch" href="/wiki/assets/js/81.970871a6.js"><link rel="prefetch" href="/wiki/assets/js/82.bb5d2dc8.js"><link rel="prefetch" href="/wiki/assets/js/83.8de53aa2.js"><link rel="prefetch" href="/wiki/assets/js/84.c9b6e608.js"><link rel="prefetch" href="/wiki/assets/js/85.640dda34.js"><link rel="prefetch" href="/wiki/assets/js/86.7715c7f8.js"><link rel="prefetch" href="/wiki/assets/js/87.474937de.js"><link rel="prefetch" href="/wiki/assets/js/88.f683e855.js"><link rel="prefetch" href="/wiki/assets/js/89.21791e95.js"><link rel="prefetch" href="/wiki/assets/js/9.c1108666.js"><link rel="prefetch" href="/wiki/assets/js/90.0d44e1e4.js"><link rel="prefetch" href="/wiki/assets/js/91.870aa661.js"><link rel="prefetch" href="/wiki/assets/js/92.14966eca.js"><link rel="prefetch" href="/wiki/assets/js/93.ce11f5cf.js"><link rel="prefetch" href="/wiki/assets/js/94.9083fb5f.js"><link rel="prefetch" href="/wiki/assets/js/95.bd6d7e58.js"><link rel="prefetch" href="/wiki/assets/js/96.91642449.js"><link rel="prefetch" href="/wiki/assets/js/97.ceb270cd.js"><link rel="prefetch" href="/wiki/assets/js/98.62c2ed1c.js"><link rel="prefetch" href="/wiki/assets/js/99.1e362e95.js">
    <link rel="stylesheet" href="/wiki/assets/css/0.styles.28a8e502.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/wiki/" class="home-link router-link-active"><!----> <span class="site-name">TIL wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/pravusid/TIL" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/pravusid/TIL" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Go 동시성</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/wiki/Go/go-concurrency.html#고루틴" class="sidebar-link">고루틴</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#병렬성과-병행성" class="sidebar-link">병렬성과 병행성</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#고루틴-기다리기" class="sidebar-link">고루틴 기다리기</a></li></ul></li><li><a href="/wiki/Go/go-concurrency.html#채널" class="sidebar-link">채널</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#일대일-단방향-채널-소통" class="sidebar-link">일대일 단방향 채널 소통</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#생성기-패턴" class="sidebar-link">생성기 패턴</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#버퍼-있는-채널" class="sidebar-link">버퍼 있는 채널</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#닫힌-채널" class="sidebar-link">닫힌 채널</a></li></ul></li><li><a href="/wiki/Go/go-concurrency.html#동시성-패턴" class="sidebar-link">동시성 패턴</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#파이프라인-패턴" class="sidebar-link">파이프라인 패턴</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#채널-공유로-팬아웃-하기" class="sidebar-link">채널 공유로 팬아웃 하기</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#팬인-하기" class="sidebar-link">팬인 하기</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#분산처리" class="sidebar-link">분산처리</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#select" class="sidebar-link">select</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#파이프라인-중단하기" class="sidebar-link">파이프라인 중단하기</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#컨텍스트-context-context-활용" class="sidebar-link">컨텍스트(context.Context) 활용</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#요청과-응답-매칭" class="sidebar-link">요청과 응답 매칭</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#동적으로-고루틴-이어붙이기" class="sidebar-link">동적으로 고루틴 이어붙이기</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#주의점" class="sidebar-link">주의점</a></li></ul></li><li><a href="/wiki/Go/go-concurrency.html#경쟁-상태" class="sidebar-link">경쟁 상태</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#동시성-디버그" class="sidebar-link">동시성 디버그</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#atomic과-sync-waitgroup" class="sidebar-link">atomic과 sync.WaitGroup</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#sync-once" class="sidebar-link">sync.Once</a></li><li class="sidebar-sub-header"><a href="/wiki/Go/go-concurrency.html#mutex-rwmutex" class="sidebar-link">Mutex / RWMutex</a></li></ul></li><li><a href="/wiki/Go/go-concurrency.html#문맥-전환" class="sidebar-link">문맥 전환</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="go-동시성"><a href="#go-동시성" class="header-anchor">#</a> Go 동시성</h1> <h2 id="고루틴"><a href="#고루틴" class="header-anchor">#</a> 고루틴</h2> <p>고루틴은 경량 스레드로 볼 수 있으며, 현재 수행 흐름과 별개 흐름을 만들어 준다.</p> <p>고루틴을 생성하는 방법은 매우 간단하다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">go</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>함수 앞에 <code>go</code>를 붙여서 호출하게 되면 메모리를 공유하는 별개의 논리적 흐름이 생성된다.</p> <h3 id="병렬성과-병행성"><a href="#병렬성과-병행성" class="header-anchor">#</a> 병렬성과 병행성</h3> <p>물리적으로 별개의 흐름이 수행되는 경우 이를 병렬성(parallelism)이라 한다.
반면 논리적으로 별개의 흐름이 수행되는 경우 이를 동시성 또는 병행성(concurrency)라고 한다.</p> <p>동시성이 있는 두 루틴은 서로 의존관계가 없다.
동시성은 병렬성과 다르지만 동시성이 있어야 병렬성이 성립하게 된다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;goroutine&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;main routine&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>main과 고루틴은 어느것이 먼저 실행될지 알 수 없으나,
만약 main이 먼저 실행되고 종료되어 버린다면 고루틴은 실행되지도 않을 수 있다.</p> <h3 id="고루틴-기다리기"><a href="#고루틴-기다리기" class="header-anchor">#</a> 고루틴 기다리기</h3> <p>고루틴을 제어하기 위한 싱크 라이브러리가 제공된다.</p> <p><a href="training/goroutine/imgzip.go">이미지 압축 예제</a></p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">download</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>wg에는 기본값이 0인 카운터가 들어가 있고 <code>Wait()</code>는 카운터가 0이 될 때까지 기다린다.</p> <p>전체 작업이 몇 개일지 알수 없는경우 wg 개수를 동적으로 할당하면 된다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">download</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>이 때 <code>wg.Add()</code>를 고루틴 내부에 포함시키면 <code>Add</code>가 수행되기 전에 <code>Wait</code>을 통과하는 race condition이 발생할 수 있다.</p> <h4 id="공유-메모리와-병렬-최소값-찾기"><a href="#공유-메모리와-병렬-최소값-찾기" class="header-anchor">#</a> 공유 메모리와 병렬 최소값 찾기</h4> <p>앞에서 고루틴은 파일시스템을 공유하였다. 마찬가지로 고루틴들은 메모리를 공유한다.</p> <p>공유 메모리를 이용하여 병렬화가 되는 예제를 풀어보자.
우선 병렬화 하지 않고 가장 작은 수를 찾는 함수를 작성해보자</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Min</span><span class="token punctuation">(</span>a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    min <span class="token operator">:=</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> min <span class="token operator">&gt;</span> e <span class="token punctuation">{</span>
            min <span class="token operator">=</span> e
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> min
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>병렬로 작동하도록 작성해보자. 병렬로 데이터를 나누어 가장 작은 수를 찾은 후, 찾은 결과를 모아 한번 더 작은 수를 찾는다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// n은 고루틴의 개수이다</span>
<span class="token keyword">func</span> <span class="token function">ParallelMin</span><span class="token punctuation">(</span>a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&lt;</span> n <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Min</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    mins <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    size <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">+</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> n
    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            begin<span class="token punctuation">,</span> end <span class="token operator">:=</span> i<span class="token operator">*</span>size<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>size
            <span class="token keyword">if</span> end <span class="token operator">&gt;</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                end <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            mins<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Min</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>begin<span class="token punctuation">:</span>end<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">Min</span><span class="token punctuation">(</span>mins<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>i번째 고루틴은 i번째 배열에 병렬로 값을 넣게 된다.</p> <h2 id="채널"><a href="#채널" class="header-anchor">#</a> 채널</h2> <p>고루틴과 데이터를 주고 받기 위해 메모리나 파일시스템을 공유할 수도 있으나, 채널을 활용하는 것도 가능하다.</p> <p>채넣은 넣은 데이터를 뽑아낼 수 있는 파이프같은 형태의 자료구조이다.
채널에 데이터를 넣고 뽑아서 다른 고루틴과 통신을 할 수 있다.</p> <p>채널을 사용하려면 <code>chan</code>을 쓰고 주고받을 자료형을 쓰면 된다.
채널은 양방향 채널과 단방향 채널이 있으며 양방향 채널은 단방향 채널로 변환해서 쓸 수 있다.</p> <p>채널을 서로 복사하는 경우 동일 채널을 가리키는 것이 된다.
따라서 채널은 그 자체로 포인터와 비슷한 레퍼런스 형이라고 할 수 있다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>c1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> c2 <span class="token operator">=</span> c1
<span class="token keyword">var</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> c3 <span class="token operator">=</span> c1
<span class="token keyword">var</span> <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span> c4 <span class="token operator">=</span> c1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>c1을 새 정수 채널로 만들었고 c2는 다른 채널 변수에 c1을 할당한 것이다. c1과 c2는 동일 채널이다.
복사시에 동일한 채널이므로 함수를 호출할 때 채널을 넘기면 함수내에서 동일한 채널에 값을 넣고 뺄 수 있다.</p> <p>c3의 자료형은 왼쪽 화살표가 있는데 자료를 뺄수만 있는 채널이다(받기 전용).
c4의 자료형은 오른쪽에 화살표가 있고 자료를 넣을 수만 있는 채널이다(보내기 전용).</p> <p>채널에 자료를 보낼 때 채널 왼쪽 화살표 자료 순으로 작성한다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>c <span class="token operator">&lt;-</span> <span class="token number">100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>채널에서 자료를 받을때는 채널 왼쪽에 화살표를 붙이면 된다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="일대일-단방향-채널-소통"><a href="#일대일-단방향-채널-소통" class="header-anchor">#</a> 일대일 단방향 채널 소통</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Example_simpleChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c <span class="token operator">&lt;-</span> <span class="token number">1</span>
        c <span class="token operator">&lt;-</span> <span class="token number">2</span>
        c <span class="token operator">&lt;-</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>c<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>c<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>c<span class="token punctuation">)</span>
    <span class="token comment">// Output:</span>
    <span class="token comment">// 1</span>
    <span class="token comment">// 2</span>
    <span class="token comment">// 3</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>하지만 보내는 고루틴과 받는 고루틴의 숫자가 맞지 않으면 고루틴이 멈춘다.
보내는 고루틴이 들어왔으나 받는 고루틴이 호출되지 않는다면 고루틴은 멈춰있게 되고,
다른 고루틴으로 문맥 전환(context switching)이 발생한다.</p> <p>받는 부분과 보내는 부분이 데이터의 개수를 알지 못해도 동작하도록 수정해보자</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Example_simpleChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c <span class="token operator">&lt;-</span> <span class="token number">1</span>
        c <span class="token operator">&lt;-</span> <span class="token number">2</span>
        c <span class="token operator">&lt;-</span> <span class="token number">3</span>
        <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> num <span class="token operator">:=</span> <span class="token keyword">range</span> c <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Output:</span>
    <span class="token comment">// 1</span>
    <span class="token comment">// 2</span>
    <span class="token comment">// 3</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>함수가 채널을 반환하게 만드는 패턴을 사용할 수 있다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Example_simpleChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
        c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
            c <span class="token operator">&lt;-</span> <span class="token number">1</span>
            c <span class="token operator">&lt;-</span> <span class="token number">2</span>
            c <span class="token operator">&lt;-</span> <span class="token number">3</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> c
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> num <span class="token operator">:=</span> <span class="token keyword">range</span> c <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Output:</span>
    <span class="token comment">// 1</span>
    <span class="token comment">// 2</span>
    <span class="token comment">// 3</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="생성기-패턴"><a href="#생성기-패턴" class="header-anchor">#</a> 생성기 패턴</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 피보나치 수열을 max까지 생성</span>
<span class="token keyword">func</span> <span class="token function">Fibonacci</span><span class="token punctuation">(</span>max <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
        <span class="token keyword">for</span> a <span class="token operator">&lt;=</span> max <span class="token punctuation">{</span>
            c <span class="token operator">&lt;-</span> a
            a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a<span class="token operator">+</span>b
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleFibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> fib <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">Fibonacci</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>fib<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Output:</span>
    <span class="token comment">// 0, 1, 1, 2, 3, 5, 8, 13</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>클로저를 이용하여 생성기를 만든다면 다음과 같다</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">FibonacciGenerator</span><span class="token punctuation">(</span>max <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    next<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
        next<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token operator">+</span>b
        <span class="token keyword">if</span> next <span class="token operator">&gt;</span> max <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> next
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleFibonacciGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fib <span class="token operator">:=</span> <span class="token function">FibonacciGenerator</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">=</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Output:</span>
    <span class="token comment">// 0, 1, 1, 2, 3, 5, 8, 13</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>생성기 패턴을 이용하면 몇 가지 장점이 있다</p> <ol><li>생성하는 쪽에서 상태 저장 방법을 고민할 필요가 없다</li> <li>받는 쪽에서는 for의 range를 이용할 수 있다</li> <li>채널 버퍼를 이용하면 멀티 코어를 활용하거나 입출력 성능상의 장점을 이용할 수 있다.</li></ol> <p>for의 range를 이용하는 예제를 살펴보자.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">BabyNames</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span> <span class="token keyword">chan</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> first <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> s <span class="token punctuation">:</span> <span class="token keyword">range</span> second <span class="token punctuation">{</span>
                c <span class="token operator">&lt;-</span> <span class="token function">string</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleBabyNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">BabyNames</span><span class="token punctuation">(</span><span class="token string">&quot;성정명재경&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;준호우훈진&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="버퍼-있는-채널"><a href="#버퍼-있는-채널" class="header-anchor">#</a> 버퍼 있는 채널</h3> <p>버퍼가 없는 채널에 값을 보낼때는 받는쪽도 준비되어 있어야 한다.</p> <p>받는쪽에 준비가 없어도 보내는 쪽이 미리 보내려면 채널에 버퍼를 잡으면 된다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 버퍼의 크기가 10인 정수 채널</span>
c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="닫힌-채널"><a href="#닫힌-채널" class="header-anchor">#</a> 닫힌 채널</h3> <p>채널에서 값을 받을 때 두번째 변수로 채널이 열려있는지 여부를 알수있다</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>val<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>채널이 열려있다면 ok는 true가 되고, 채널이 닫혀있다면 ok는 false val은 타입 기본값이 들어온다.</p> <p>만약 채널에 값이 없는 상태라면 열려있는 채널은 값이 들어올때까지 block 상태로 대기하고,
닫혀있는 채널은 기다리지 않고 기본값을 받고 넘어간다.</p> <p>만약 닫은 채널을 다시 닫으면 패닉이 발생한다.</p> <h2 id="동시성-패턴"><a href="#동시성-패턴" class="header-anchor">#</a> 동시성 패턴</h2> <h3 id="파이프라인-패턴"><a href="#파이프라인-패턴" class="header-anchor">#</a> 파이프라인 패턴</h3> <p>파이프라인은 한 단계의 출력이 다음 단계의 입력으로 이어지는 구조이다.</p> <p>파이프라인 패턴은 생성기 패턴의 일종이다. 받기 전용 채널을 넘겨받아 입력으로 활용한다.
생성기 패턴과 동일하게 채널은 데이터를 보내는 쪽에서 닫아야 한다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// PlusOne returns a channel of num + 1 for nums received from in</span>
<span class="token keyword">func</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">for</span> num <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
            out <span class="token operator">&lt;-</span> num <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExamplePlusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        c <span class="token operator">&lt;-</span> <span class="token number">5</span>
        c <span class="token operator">&lt;-</span> <span class="token number">3</span>
        c <span class="token operator">&lt;-</span> <span class="token number">8</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> num <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span><span class="token function">PlusOne</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Output:</span>
    <span class="token comment">// 7</span>
    <span class="token comment">// 5</span>
    <span class="token comment">// 10</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>PlusOne은 받기 전용 채널을 받아서 다른 받기 전용 채널을 돌려주는 함수이다.
받은 채널에서 숫자를 하나 증가시켜서 반환한다.</p> <p>서로 다른함수들도 이어 붙일 수 있다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> IntPipe <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token function">Chain</span><span class="token punctuation">(</span>ps <span class="token punctuation">.</span><span class="token punctuation">.</span>IntPipe<span class="token punctuation">)</span> IntPipe <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
        c <span class="token operator">:=</span> in
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> ps <span class="token punctuation">{</span>
            c <span class="token operator">=</span> <span class="token function">p</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>작성한 Chain을 이용하면 <code>A(B(c))</code>를 <code>Chain(B, A)(c)</code>와 같이 표현할 수 있다.</p> <h3 id="채널-공유로-팬아웃-하기"><a href="#채널-공유로-팬아웃-하기" class="header-anchor">#</a> 채널 공유로 팬아웃 하기</h3> <p>팬아웃(fan-out: 게이트 하나의 출력이 게이트 여러 입력으로 들어가는 경우)</p> <p>앞의 작업은 빠르게 이루어지나 후속작업에 시간이 걸려 결과물을 여러곳에 분배해야 하는 경우가 있다.
이런경우 채널 하나를 여럿에게 공유하면 된다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> n<span class="token operator">:=</span> <span class="token keyword">range</span> c <span class="token punctuation">{</span>
                time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 고루틴 3개에서 모두 출력해보기 위해서 sleep</span>
                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// 값을 넘겨 사용하지 않으면 외부의 i값과 고루틴내의 i값이 달라 결과에 문제가 발생할 수 있다</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        c <span class="token operator">&lt;-</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="팬인-하기"><a href="#팬인-하기" class="header-anchor">#</a> 팬인 하기</h3> <p>Fan-in으로 결과값을 합치려해도 채널을 공유하면 된다.
같은 채널에 여러 고루틴이 값을 보내도 받아가는 곳에서는 모든 값을 받아갈 수 있다.</p> <p>다만 여기에서 채널을 닫을 때는 주의해야 한다. 고루틴에서 채널을 닫아버리면 채널 닫기가 반복수행 되어 패닉이 발생한다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">FanIn</span><span class="token punctuation">(</span>ins <span class="token operator">...</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> in <span class="token operator">:=</span> <span class="token keyword">range</span> ins <span class="token punctuation">{</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> num <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
                out <span class="token operator">&lt;-</span> num
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out
<span class="token punctuation">}</span>

c <span class="token operator">:=</span> <span class="token function">FanIn</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="분산처리"><a href="#분산처리" class="header-anchor">#</a> 분산처리</h3> <p>팬아웃 해서 파이프라인을 통과시키고 다시 팬인시키면 분산처리를 할 수 있다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Distribute 함수는 IntPipe를 받은 뒤 n개로 분산처리 하는 함수로 돌려준다</span>
<span class="token keyword">func</span> <span class="token function">Distribute</span><span class="token punctuation">(</span>p IntPipe<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> IntPipe <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
        cs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            cs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">FanIn</span><span class="token punctuation">(</span>cs<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Distribute와 Chain을 함께 이용해서 파이프라인을 구성할 수 있다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// in으로 들어온 자료가 Cut 고루틴에서 처리되고 그 결과값이 10개로 나누어진 Draw Pain Decorate</span>
<span class="token comment">// Chain을 통과한후 합쳐져 Box 고루틴을 통과한다</span>
out <span class="token operator">:=</span> <span class="token function">Chain</span><span class="token punctuation">(</span>Cut<span class="token punctuation">,</span> <span class="token function">Distribute</span><span class="token punctuation">(</span><span class="token function">Chain</span><span class="token punctuation">(</span>Draw<span class="token punctuation">,</span> Paint<span class="token punctuation">,</span> Decorate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> Box<span class="token punctuation">)</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Go에서는 고루틴마다 스레드를 모두 할당하지 않으며,
동시에 수행될 필요가없는 고루틴은 하나의 스레드에서 순차적으로 수행되며 이는 컴파일 타임에 예측가능한 경우가 많다.</p> <h3 id="select"><a href="#select" class="header-anchor">#</a> select</h3> <p><code>select</code>를 사용하면 동시에 여러 채널과 통신할 수 있다.
<code>select</code>의 형태는 <code>switch</code>문과 비슷하지만 동시성 프로그래밍에 사용되며 다른 특성들이 있다.</p> <ul><li>모든 case가 계산된다. 함수 호출이 있으면 select를 수행할 때 모두 호출된다.</li> <li>각 case는 채널에 입출력하는 형태가 되며 막히지 않고 입출력이 가능한 case가 있으면 그중에 하나가 선택되어 입출력이 수행되고 해당 case의 코드만 수행된다.</li> <li>default가 있으면 모든 case에 입출력이 불가능할 때 코드가 수행된다. default가 없고 모든 case에 입출력이 불가능하면 가능한 case가 발생할 때까지 기다린다.</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> n <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c1<span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">&quot;is from c1&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> n <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c2<span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">&quot;is from c2&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="팬인하기"><a href="#팬인하기" class="header-anchor">#</a> 팬인하기</h4> <p><code>select</code>를 사용하면 고루틴을 여러개 이용하지 않아도 팬인 할 수 있다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> n <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c1<span class="token punctuation">:</span>
        c <span class="token operator">&lt;-</span> n
    <span class="token keyword">case</span> n <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c2<span class="token punctuation">:</span>
        c <span class="token operator">&lt;-</span> n
    <span class="token keyword">case</span> n <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c3<span class="token punctuation">:</span>
        c <span class="token operator">&lt;-</span> n
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>위 코드는 c1, c2, c3 중 어느 채널이라도 데이터가 준비되면 그것을 c로 보내는 코드이다.
select문을 반복하면 팬인을 할 수 있다.</p> <p>그러나 일부 닫혀있는 채널이 있다면 의도하지 않은 기본값이 계속 들어올 수 있다.
이를 수정한 예제를 살펴보자</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">FanIn</span><span class="token punctuation">(</span>in1<span class="token punctuation">,</span> in2<span class="token punctuation">,</span> in3 <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    openCount <span class="token operator">:=</span> <span class="token number">3</span>
    closeChan <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token boolean">nil</span>
        openCount<span class="token operator">--</span>
        <span class="token keyword">return</span> openCount <span class="token operator">==</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">{</span>
            <span class="token keyword">select</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> n<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>in1<span class="token punctuation">:</span>
                <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
                    out <span class="token operator">&lt;-</span> n
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">closeChan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> n<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>in2<span class="token punctuation">:</span>
                    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
                        out <span class="token operator">&lt;-</span> n
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">closeChan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span>
                    <span class="token punctuation">}</span>
                <span class="token keyword">case</span> n<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>in3<span class="token punctuation">:</span>
                    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
                        out <span class="token operator">&lt;-</span> n
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">closeChan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span>
                    <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    sendInts <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">,</span> begin<span class="token punctuation">,</span> end <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> begin<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            c <span class="token operator">&lt;-</span> i
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">go</span> <span class="token function">sendInts</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token function">sendInts</span><span class="token punctuation">(</span>c2<span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token function">sendInts</span><span class="token punctuation">(</span>c3<span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">FanIn</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>이 경우 닫힌 채널을 <code>nil</code>로 바꾸어준다. <code>nil</code> 채널은 받기 보내기가 모두 막힌다.
이를 반복수행하면서 열려 있는 채널이 0개가 되면 함수를 반환하고 out채널을 닫는다.</p> <h4 id="채널을-기다리지-않고-받기"><a href="#채널을-기다리지-않고-받기" class="header-anchor">#</a> 채널을 기다리지 않고 받기</h4> <p>채널에 값이 준비되지 않으면 준비될때 까지 기다리는 것이 기본동작이다.
select를 이용해서 채널값이 있으면 받고 없으면 스킵하는 흐름을 구성해보자</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> n <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c<span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Data is not ready&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="시간제한"><a href="#시간제한" class="header-anchor">#</a> 시간제한</h4> <p>채널과 통신을 기다리는 시간의 상한선을 지정하려면 <code>time.After</code> 함수를 이용할 수 있다.
이 함수는 지정된 시간이 지나면 현재시간이 전달되는 채널을 반환한다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> n <span class="token operator">:=</span> <span class="token operator">&lt;-</span>recv<span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword">case</span> send <span class="token operator">&lt;-</span> <span class="token number">1</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;sent 1&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;5초간 통신이 없음&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>전체 제한시간을 지정하려면 타이머 채널을 반복문 밖에서 할당하면 된다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>timeout <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">{</span>
    <span class="token keyword">select</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> n <span class="token operator">:=</span> <span class="token operator">&lt;-</span>recv<span class="token punctuation">:</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
        <span class="token keyword">case</span> send <span class="token operator">&lt;-</span> <span class="token number">1</span><span class="token punctuation">:</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;sent 1&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>timeout<span class="token punctuation">:</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;5초간 통신이 없음&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="파이프라인-중단하기"><a href="#파이프라인-중단하기" class="header-anchor">#</a> 파이프라인 중단하기</h3> <p>채널을 받는 쪽에서 필요한 자료를 획득하여 중간에서 채널사용을 끝내고 싶은 경우가 있다.
만약 채널에서 데이터를 받는 루프를 끝내버리면 고루틴은 여전히 메모리상에서 작동하므로 자원 낭비가 발생한다.</p> <p>그렇다고 받는 쪽에서 채널을 닫아버리면 보내는쪽에서 채널에 접근할 때 패닉이 발생한다.</p> <p>이때 done 채널을 하나더 만들어 보내는 고루틴에서 종료를 감지하게 만들면 된다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span>done <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">for</span> num <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
            <span class="token keyword">select</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> out <span class="token operator">&lt;-</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
                    <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">103</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">10</span> <span class="token punctuation">{</span>
            c <span class="token operator">&lt;-</span> i
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    nums <span class="token operator">:=</span> <span class="token function">plusOne</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token function">Plusone</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> num <span class="token operator">:=</span> <span class="token keyword">range</span> nums <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
        <span class="token keyword">if</span> num <span class="token operator">==</span> <span class="token number">18</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;고루틴수: &quot;</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">NumGoroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token keyword">range</span> nums <span class="token punctuation">{</span>
        <span class="token comment">// consume all nums</span>
    <span class="token punctuation">}</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;고루틴수: &quot;</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">NumGoroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><code>close(done)</code>을 호출해서 done채널을 select로 받고있는 곳(보내는 채널)에 기본값이 전송되고 채널을 닫게 된다.</p> <h3 id="컨텍스트-context-context-활용"><a href="#컨텍스트-context-context-활용" class="header-anchor">#</a> 컨텍스트(context.Context) 활용</h3> <p>위와 같이 done 채널을 운영해도 되지만 복잡한 상황을 대비해 context 패턴을 이용하는 것이 좋다.</p> <p>사용을 위해서는 라이브러리를 설치해야 한다: <code>go get golang.org/x/net/context</code></p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> it <span class="token punctuation">{</span>
    out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">for</span> num <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
            <span class="token keyword">select</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> out <span class="token operator">&lt;-</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">103</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">10</span> <span class="token punctuation">{</span>
            c <span class="token operator">&lt;-</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    nums <span class="token operator">:=</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> num <span class="token operator">:=</span> <span class="token keyword">range</span> nums <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
        <span class="token keyword">if</span> num <span class="token operator">==</span> <span class="token number">18</span> <span class="token punctuation">{</span>
            <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><code>context.Background()</code>가 가장 상위에 존재하여 프로그램 종료시까지 계속 살아있다.
<code>context.WithCancel()</code>로 최상위 컨텍스트에 취소 기능을 붙이고, ctx에 컨텍스트를 cancel에 취소 호출함수를 할당한다.</p> <p><code>WithDeadline</code>, <code>WithTimeout</code>을 이용하여 시간이 지나면 취소되게 할 수도 있다.</p> <p>컨텍스트는 관례상 함수의 첫 번째 인자로 넘겨주고 받는다.</p> <h3 id="요청과-응답-매칭"><a href="#요청과-응답-매칭" class="header-anchor">#</a> 요청과 응답 매칭</h3> <p>데이터를 받았을 때 어느요청에 대한 응답인지 알아야 하는 경우가 있다.</p> <p>한 가지 방법은 채널로 자료를 넘겨주고 받을 때 id 번호를 같이 넘겨 확인하는 것이다.
그러나 요청에 대한 응답을 다른 고루틴이 가져가면 의도하지 않은 결과가 발생할 수 있다.</p> <p>이런경우 보내는 Request 구조체에 받을 채널도 함께 넣어서 보내면 된다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Request <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Num     <span class="token builtin">int</span>
    Resp    <span class="token keyword">chan</span> Response
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Response <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Num         <span class="token builtin">int</span>
    WorkerId    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">PlusOneService</span><span class="token punctuation">(</span>reqs <span class="token operator">&lt;-</span><span class="token keyword">chan</span> Request<span class="token punctuation">,</span> workerId <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> req <span class="token operator">:=</span> <span class="token keyword">range</span> reqs <span class="token punctuation">{</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>req Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Resp<span class="token punctuation">)</span>
            req<span class="token punctuation">.</span>Resp <span class="token operator">&lt;-</span> <span class="token function">Response</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> workerId<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    reqs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> Request<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>reqs<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">go</span> <span class="token function">PlusOneService</span><span class="token punctuation">(</span>reqs<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">53</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">10</span> <span class="token punctuation">{</span>
        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            resps <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> Response<span class="token punctuation">)</span>
            reqs <span class="token operator">&lt;-</span> Request<span class="token punctuation">{</span>i<span class="token punctuation">,</span> resps<span class="token punctuation">}</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">&quot;=&gt;&quot;</span><span class="token punctuation">,</span> <span class="token operator">&lt;-</span>resps<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="동적으로-고루틴-이어붙이기"><a href="#동적으로-고루틴-이어붙이기" class="header-anchor">#</a> 동적으로 고루틴 이어붙이기</h3> <p>prime의 배수를 걸러내는 고루틴을 계속해서 이어붙이는 예제</p> <p>2부터 숫자를 하나씩 증가시켜 채널에 보내고, 다른 고루틴에서는 채널에서 숫자를 받을 때마다 출력한다.
출력된 숫자의 배수가 되는 숫자들을 걸러내는 필터 고루틴을 이어붙이면 출력된 숫자들은 모두 소수가 된다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Range returns a channel and sends ints</span>
<span class="token comment">// (start, start+step, start+2*step)</span>
<span class="token keyword">func</span> <span class="token function">Range</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> start<span class="token punctuation">,</span> step <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> start<span class="token punctuation">;</span> <span class="token punctuation">;</span> i <span class="token operator">+=</span> step <span class="token punctuation">{</span>
            <span class="token keyword">select</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> out <span class="token operator">&lt;-</span> i
                <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span>Done<span class="token punctuation">:</span>
                    <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token comment">//FilterMultiple returns a IntPipe that filters multiple of n</span>
<span class="token keyword">func</span> <span class="token function">FilterMultiple</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> IntPipe <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
        out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
            <span class="token keyword">for</span> x <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
                <span class="token keyword">if</span> x<span class="token operator">%</span>n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">select</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> out <span class="token operator">&lt;-</span> x<span class="token punctuation">:</span>
                    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Primes</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        c <span class="token operator">:=</span> <span class="token function">Range</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">{</span>
            <span class="token keyword">select</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> i <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c<span class="token punctuation">:</span>
                    c <span class="token operator">=</span> <span class="token function">FilterMultiple</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
                    <span class="token keyword">select</span> <span class="token punctuation">{</span>
                        <span class="token keyword">case</span> out <span class="token operator">&lt;-</span> i<span class="token punctuation">:</span>
                        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                            <span class="token keyword">return</span>
                    <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p><code>&lt;-c</code>를 받는 부분에서 막혀있으면 ctx가 취소될 수 있고
여기에서 받은 값을 <code>out &lt;- i</code> 처럼 보낼 때 막혀있다 ctx가 취소될 수 있으므로 select를 다중으로 만들어야 한다.</p> <p>Primes를 이용하는 코드 예제 이다</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">PrintPrimes</span><span class="token punctuation">(</span>max <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> prime <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">Primes</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> prime <span class="token operator">&gt;</span> max <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>prime<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="주의점"><a href="#주의점" class="header-anchor">#</a> 주의점</h3> <ul><li>자료를 보내는 채널은 보내는 쪽에서 닫는다</li> <li>보내는 쪽에서 반복문 등을 활용하여 보냈다가 중간에 return을 할 수 있으므로 닫을 때에는 defer를 이용하는 것이 좋다. 그렇지 않으면 중간에 return 했을 때 채널을 닫지 않고 종료할 수 있다.</li> <li>모든 자료처리가 끝나는 시점까지 기다리는 방법으로는 받는 쪽이 끝날때까지 기다리는 것이 더 안정적이다. 즉 생산자가 아닌 소비자 쪽에서 <code>done &lt;- true</code>를 호출하고 생산자는 끝났다는 신호를 받아 채널을 닫아야 한다.</li> <li>특별한 이유가 없다면 받는 쪽에서는 range를 이용하는 것이 좋다. 생산자가 채널을 닫은 경우에 반복문을 빠져나오므로 편리하다.</li> <li>루틴이 끝났음을 알리고 다른 쪽에서 기다리는 것은 <code>sync.WaitGroup</code>을 이용하는 것이 나은 경우가 많다.</li> <li>끝났음을 알리는 <code>done</code> 채널은 자료를 보내는 쪽에서 결정하지말고 차라리 채널을 닫아서 끝났음을 알리는 것이 낫다.</li> <li><code>done</code> 채널에 자료를 보내어 신호를 주는 것 보다 <code>close(done)</code>으로 채널을 닫는것이 나은 경우가 많다.</li></ul> <h2 id="경쟁-상태"><a href="#경쟁-상태" class="header-anchor">#</a> 경쟁 상태</h2> <p>고루틴들을 사용하다보면 서로 막혀 교착 상태(dead lock)이 발생하는 경우 오류가 출력되지만,
경쟁 상태(race condition)의 경우 쉽게 발견할 수 없는 버그가 될 수 있다.</p> <p>경쟁 상태는 공유된 자원에 둘 이상의 프로세스가 동시에 접근하여 잘못된 결과가 나올 수 있는 상태이다.
타이밍에 따라서 결과가 달라지므로 알아채기도, 고치기도 번거로운 버그가 될 수 있다.</p> <h3 id="동시성-디버그"><a href="#동시성-디버그" class="header-anchor">#</a> 동시성 디버그</h3> <p>Go 도구에서 <code>-race</code> 옵션을 주면 경쟁 상태를 탐지할 수 있다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">go</span> test <span class="token operator">-</span>race mypkg
<span class="token keyword">go</span> run <span class="token operator">-</span>race mysrc<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token keyword">go</span> build <span class="token operator">-</span>race mycmd
<span class="token keyword">go</span> install <span class="token operator">-</span>race mypkg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>동적으로 고루틴을 이어붙일때 메모리 누수가 일어나는지 알아보기 위해서 <code>runtime.NumGoroutine()</code>을 호출하면 된다.</p> <p><code>runtime.NumCPU()</code>와 <code>runtime.GOMAXPROCS()</code>를 이용하여 현재 사용가능한 CPU 수와 얼마의 CPU를 이용할지 통제할 수도 있다.</p> <h3 id="atomic과-sync-waitgroup"><a href="#atomic과-sync-waitgroup" class="header-anchor">#</a> atomic과 sync.WaitGroup</h3> <p><code>sync/atomic</code> 패키지에는 여러 경쟁상태를 대비하기 위한 함수들이 있다.</p> <p>채널을 이용해도 복잡한 문제를 쉽개 해결할 수 있다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">,</span> resp <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int64</span><span class="token punctuation">)</span>
    cnt <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cnt <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token keyword">range</span> req <span class="token punctuation">{</span>
            cnt<span class="token operator">--</span>
            resp <span class="token operator">&lt;-</span> cnt
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// do somthing</span>
            req <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> cnt <span class="token operator">=</span> <span class="token operator">&lt;-</span>resp<span class="token punctuation">;</span> cnt <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> cnt <span class="token operator">=</span> <span class="token operator">&lt;-</span>resp <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>코드에 의도를 명확히 나타내기 위해 WaitGroup을 사용할 수도 있다</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// do something</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="sync-once"><a href="#sync-once" class="header-anchor">#</a> sync.Once</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;initialized&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">&lt;-</span>done
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Goroutine:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>이 경우 고루틴의 실행순서는 알 수 없으나 고루틴들은 <code>&lt;-done</code>으로 먼저 기다린 후 실행되므로 초기화 코드가 우선 수행된다.</p> <p>이렇게 한 번만 코드를 수행할때 쓸 수 있는 것이 <code>sync.Once</code>이다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> once sync<span class="token punctuation">.</span>Once
    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;initialized&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Goroutine:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="mutex-rwmutex"><a href="#mutex-rwmutex" class="header-anchor">#</a> Mutex / RWMutex</h3> <p>뮤텍스(mutex)는 상호 배타 잠금기능이 있다.
동시에 둘 이상의 고루틴에서 코드 흐름을 제어할 수 있다. 외부자원에 접근하는 경우 활용하면 효과적이다.</p> <p>뮤텍스를 활용하는 방법 중 하나는 접근하고자 하는 자원 포인터와 뮤텍스 포인터를 하나의 구조체에 넣어 사용하는 것이다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Accessor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    R   <span class="token operator">*</span>Resource
    L   <span class="token operator">*</span>sync<span class="token punctuation">.</span>Mutex
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>생성할 때 <code>Accessor{&amp;resource, &amp;sync.Mutex{}}</code>와 같이 할당해주고 자원에 접근하는 메소드에서 <code>Lock</code>을 활용한다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>acc <span class="token operator">*</span>Accessor<span class="token punctuation">)</span> <span class="token function">Use</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
    acc<span class="token punctuation">.</span>L<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// Use acc.R</span>
    acc<span class="token punctuation">.</span>L<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//do something else</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>sync.RWMutex</code>는 조금 더 복잡하다.
어떤 자원에 여러 프로세스가 쓰기 접근을 한다면 다른 프로세스 모두 그 동안 접근할 수 없는 경우 이용된다.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> ConcurrentMap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    M   <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    L   <span class="token operator">*</span>sync<span class="token punctuation">.</span>RWMutex
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m ConcurrentMap<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    m<span class="token punctuation">.</span>L<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> m<span class="token punctuation">.</span>L<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> m<span class="token punctuation">.</span>M<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m ConcurrentMap<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m<span class="token punctuation">.</span>L<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    m<span class="token punctuation">.</span>M<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
    m<span class="token punctuation">.</span>L<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m <span class="token operator">:=</span> ConcurrentMap<span class="token punctuation">{</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>RWMutex<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>RWMutex도 Mutex의 일종이므로 RLock과 RUnlock을 사용하지 않고 Lock과 Unlock만 사용하면 Mutex와 동일하다.</p> <h2 id="문맥-전환"><a href="#문맥-전환" class="header-anchor">#</a> 문맥 전환</h2> <p>문맥 전환 (context switching)이란 프로그램이 여러 프로세스 혹은 스레드에서 동작할 때
기존에 하던 작업들을 메모리에 보관해두고 다른 작업을 시작하는 것을 말한다.</p> <p>문맥 전환을 이용하여 프로그램이 병행적으로 수행될 수 있지만 이때 비용이 발생한다.</p> <p>고루틴은 스레드보다 비용이 낮다. 고루틴을 여러개 만들어도 스레드는 그것보다 적게 만들어지고
어러 개의 고루틴이 하나의 스레드에 대응된다.</p> <p>Go 컴파일러가 어떤 고루틴들이 하나의 스레드에 묶이는 것이 좋은지를 분석하면 스레드의 문맥전환을 하지 않도록 코드를 생성한다.</p> <p>Go 컴파일러는 주로 다음의 경우에 문맥 전환을 하는 코드를 생성할 수도 있다.</p> <ul><li>파일이나 네트워크 연산처럼 시간이 오래 걸리는 입출력 연산이 있을 때</li> <li>채널에 보내거나 받을 때</li> <li>go로 고루틴이 생성될 때</li> <li>가비지 컬렉션 사이클이 지난 뒤</li></ul> <p>Go의 입출력은 주로 블럭킹이다. 이때 다른 고루틴으로 문맥 전환하는 것은 매우 좋은 방식이다.</p> <p>Go 언어를 만든 사람들은 논블록킹 비동기 입출력이 혼란스럽다고 생각하여 동시성이 있는 고루틴을 생성하고
고루틴에서 동기화 입출력을 하면서 필요한 문맥전환을 하는 방식을 이용하여 설계 하였다.</p> <p>문맥 전환을 강제로 시키기 위한 코드 중 하나는 <code>time.Sleep(0)</code>이다.
문맥 전환 없이 끝나지 않는 연산을 수행하는 코드가 있다면 다른 고루틴은 처리 기회를 받지 못할수도 있기 때문이다.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/wiki/assets/js/app.36606fb6.js" defer></script><script src="/wiki/assets/js/2.05cc4ee4.js" defer></script><script src="/wiki/assets/js/71.8dff6073.js" defer></script>
  </body>
</html>
