(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{387:function(e,t,s){"use strict";s.r(t);var a=s(28),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"aws-codedeploy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aws-codedeploy"}},[e._v("#")]),e._v(" AWS CodeDeploy")]),e._v(" "),s("h2",{attrs:{id:"codedeploy-agent"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#codedeploy-agent"}},[e._v("#")]),e._v(" CodeDeploy Agent")]),e._v(" "),s("ul",[s("li",[e._v("CLI 환경에서 Agent 설치: "),s("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/codedeploy-agent-operations-install-linux.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/codedeploy-agent-operations-install-linux.html"),s("OutboundLink")],1)]),e._v(" "),s("li",[e._v("CodeDeploy Agent 사용자 변경: "),s("a",{attrs:{href:"https://aws.amazon.com/ko/premiumsupport/knowledge-center/codedeploy-agent-non-root-profile/",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://aws.amazon.com/ko/premiumsupport/knowledge-center/codedeploy-agent-non-root-profile/"),s("OutboundLink")],1)])]),e._v(" "),s("h3",{attrs:{id:"codedeploy-agent-in-amazonlinux"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#codedeploy-agent-in-amazonlinux"}},[e._v("#")]),e._v(" CodeDeploy Agent in AmazonLinux")]),e._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" yum "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" -y ruby\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" -O https://aws-codedeploy-ap-northeast-2.s3.amazonaws.com/latest/install\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("chmod")]),e._v(" +x "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" ./install auto\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sed")]),e._v(" -i "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('\'s/""/"ec2-user"/g\'')]),e._v(" /etc/init.d/codedeploy-agent\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 중요: Amazon Linux 2 AMI의 경우 다음 추가 명령을 실행합니다.")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sed")]),e._v(" -i "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'s/#User=codedeploy/User=ec2-user/g'")]),e._v(" /usr/lib/systemd/system/codedeploy-agent.service\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" systemctl daemon-reload\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("chown")]),e._v(" ec2-user:ec2-user -R /opt/codedeploy-agent/\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("chown")]),e._v(" ec2-user:ec2-user -R /var/log/aws/\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" systemctl "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("enable")]),e._v(" codedeploy-agent\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" systemctl start codedeploy-agent\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" systemctl status codedeploy-agent\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("ps")]),e._v(" aux "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("grep")]),e._v(" codedeploy-agent\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br")])]),s("h3",{attrs:{id:"agent-실행-환경변수"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#agent-실행-환경변수"}},[e._v("#")]),e._v(" agent 실행 환경변수")]),e._v(" "),s("p",[e._v("agent 실행시 환경변수는 다음과 같음")]),e._v(" "),s("ol",[s("li",[e._v("LIFECYCLE_EVENT : This variable contains the name of the lifecycle event associated with the script.")]),e._v(" "),s("li",[e._v("DEPLOYMENT_ID : This variables contains the deployment ID of the current deployment.")]),e._v(" "),s("li",[e._v("APPLICATION_NAME : This variable contains the name of the application being deployed. This is the name the user sets in the console or AWS CLI.")]),e._v(" "),s("li",[e._v("DEPLOYMENT_GROUP_NAME : This variable contains the name of the deployment group. A deployment group is a set of instances associated with an application that you target for a deployment.")]),e._v(" "),s("li",[e._v("DEPLOYMENT_GROUP_ID : This variable contains the ID of the deployment group in AWS CodeDeploy that corresponds to the current deployment")])]),e._v(" "),s("h2",{attrs:{id:"준비"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#준비"}},[e._v("#")]),e._v(" 준비")]),e._v(" "),s("ul",[s("li",[e._v("배포할 데이터를 업로드할 "),s("strong",[e._v("S3 bucket 생성")])]),e._v(" "),s("li",[e._v("외부 트리거(CI...)에서 사용할 "),s("strong",[s("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/getting-started-provision-user.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("IAM 사용자를 추가"),s("OutboundLink")],1)]),e._v(" "),s("ul",[s("li",[e._v("S3 접근권한 ("),s("code",[e._v("action:s3:PutObject")]),e._v(")")]),e._v(" "),s("li",[e._v("CodeDeploy 권한 ("),s("code",[e._v("POLICY:AWSCodeDeployDeployerAccess")]),e._v(")")])])]),e._v(" "),s("li",[e._v("CodeDeploy가 배포를 진행하기 위한 "),s("strong",[s("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/getting-started-create-service-role.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("CodeDeploy Role 생성"),s("OutboundLink")],1)])]),e._v(" "),s("li",[e._v("EC2에서 작업을 수행하기 위해 "),s("strong",[s("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/getting-started-create-iam-instance-profile.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("S3 접근 권한이 있는 Role 생성"),s("OutboundLink")],1)]),e._v(" 후 EC2에 Role 할당")]),e._v(" "),s("li",[e._v("CodeDeploy 웹 콘솔에서 "),s("strong",[s("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/deployment-groups-create.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("배포 그룹 생성(ARN에서 기존에 생성한 CodeDeploy Role 선택)"),s("OutboundLink")],1)]),e._v(" 후 배포 애플리케이션 생성")])]),e._v(" "),s("h2",{attrs:{id:"appspec-yml"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#appspec-yml"}},[e._v("#")]),e._v(" "),s("code",[e._v("appspec.yml")])]),e._v(" "),s("p",[s("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/reference-appspec-file.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/reference-appspec-file.html"),s("OutboundLink")],1)]),e._v(" "),s("p",[e._v("최소 기능 스크립트 ("),s("code",[e._v("runas")]),e._v(" 사용시 사용자 암호 입력이 필요하다면 오류발생함)")]),e._v(" "),s("div",{staticClass:"language-yml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0.0")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("os")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" linux\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("files")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("source")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" ./\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("destination")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" /home/ec2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("user/deployment/\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("hooks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("BeforeInstall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("location")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" scripts/deploy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("prepare.sh\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("runas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" ec2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("user\n "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("ApplicationStart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("location")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" scripts/deploy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("run.sh\n     "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("runas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" ec2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("user\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br")])]),s("ul",[s("li",[e._v("스크립트가 실행되는 경로는 Code Deploy Agent가 설치된 경로임 "),s("code",[e._v("/opt/codedeploy-agent")])]),e._v(" "),s("li",[e._v("실제 파일 경로는: "),s("code",[e._v("/opt/codedeploy-agent/deployment-root/{deployment-group-ID}/{deployment-ID}")])])])])}),[],!1,null,null,null);t.default=n.exports}}]);