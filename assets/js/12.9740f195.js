(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{379:function(e,s,t){"use strict";t.r(s);var a=t(28),n=Object(a.a)({},(function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"aws-codedeploy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aws-codedeploy"}},[e._v("#")]),e._v(" AWS CodeDeploy")]),e._v(" "),t("h2",{attrs:{id:"codedeploy-agent"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#codedeploy-agent"}},[e._v("#")]),e._v(" CodeDeploy Agent")]),e._v(" "),t("h3",{attrs:{id:"codedeploy-agent-in-amazonlinux"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#codedeploy-agent-in-amazonlinux"}},[e._v("#")]),e._v(" CodeDeploy Agent in AmazonLinux")]),e._v(" "),t("p",[e._v("CLI 환경에서 Agent 설치: "),t("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/codedeploy-agent-operations-install-linux.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/codedeploy-agent-operations-install-linux.html"),t("OutboundLink")],1)]),e._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" -y ruby\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" -O https://aws-codedeploy-ap-northeast-2.s3.amazonaws.com/latest/install\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("chmod")]),e._v(" +x "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" ./install auto\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br")])]),t("p",[e._v("CodeDeploy Agent 사용자 변경: "),t("a",{attrs:{href:"https://aws.amazon.com/ko/premiumsupport/knowledge-center/codedeploy-agent-non-root-profile/",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://aws.amazon.com/ko/premiumsupport/knowledge-center/codedeploy-agent-non-root-profile/"),t("OutboundLink")],1)]),e._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("service")]),e._v(" codedeploy-agent stop\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sed")]),e._v(" -i "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('\'s/""/"ec2-user"/g\'')]),e._v(" /etc/init.d/codedeploy-agent\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 중요: Amazon Linux 2 AMI의 경우 다음 추가 명령을 실행합니다.")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sed")]),e._v(" -i "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v("'s/#User=codedeploy/User=ec2-user/g'")]),e._v(" /usr/lib/systemd/system/codedeploy-agent.service\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" systemctl daemon-reload\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("chown")]),e._v(" ec2-user:ec2-user -R /opt/codedeploy-agent/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("chown")]),e._v(" ec2-user:ec2-user -R /var/log/aws/\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" systemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("enable")]),e._v(" codedeploy-agent\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" systemctl start codedeploy-agent\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" systemctl status codedeploy-agent\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("ps")]),e._v(" aux "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("grep")]),e._v(" codedeploy-agent\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br"),t("span",{staticClass:"line-number"},[e._v("12")]),t("br"),t("span",{staticClass:"line-number"},[e._v("13")]),t("br"),t("span",{staticClass:"line-number"},[e._v("14")]),t("br"),t("span",{staticClass:"line-number"},[e._v("15")]),t("br"),t("span",{staticClass:"line-number"},[e._v("16")]),t("br")])]),t("h3",{attrs:{id:"agent-실행-환경변수"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#agent-실행-환경변수"}},[e._v("#")]),e._v(" Agent 실행 환경변수")]),e._v(" "),t("p",[e._v("Agent 실행시 환경변수는 다음과 같음")]),e._v(" "),t("ol",[t("li",[t("code",[e._v("LIFECYCLE_EVENT")]),e._v(" : This variable contains the name of the lifecycle event associated with the script.")]),e._v(" "),t("li",[t("code",[e._v("DEPLOYMENT_ID")]),e._v(" : This variables contains the deployment ID of the current deployment.")]),e._v(" "),t("li",[t("code",[e._v("APPLICATION_NAME")]),e._v(" : This variable contains the name of the application being deployed. This is the name the user sets in the console or AWS CLI.")]),e._v(" "),t("li",[t("code",[e._v("DEPLOYMENT_GROUP_NAME")]),e._v(" : This variable contains the name of the deployment group. A deployment group is a set of instances associated with an application that you target for a deployment.")]),e._v(" "),t("li",[t("code",[e._v("DEPLOYMENT_GROUP_ID")]),e._v(" : This variable contains the ID of the deployment group in AWS CodeDeploy that corresponds to the current deployment")])]),e._v(" "),t("h2",{attrs:{id:"준비"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#준비"}},[e._v("#")]),e._v(" 준비")]),e._v(" "),t("ul",[t("li",[e._v("배포할 데이터를 업로드할 "),t("strong",[e._v("S3 bucket 생성")])]),e._v(" "),t("li",[e._v("외부 트리거(CI...)에서 사용할 "),t("strong",[t("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/getting-started-provision-user.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("IAM 사용자를 추가"),t("OutboundLink")],1)]),e._v(" "),t("ul",[t("li",[e._v("S3 접근권한 ("),t("code",[e._v("action:s3:PutObject")]),e._v(")")]),e._v(" "),t("li",[e._v("CodeDeploy 권한 ("),t("code",[e._v("POLICY:AWSCodeDeployDeployerAccess")]),e._v(")")])])]),e._v(" "),t("li",[e._v("CodeDeploy가 배포를 진행하기 위한 "),t("strong",[t("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/getting-started-create-service-role.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("CodeDeploy Role 생성"),t("OutboundLink")],1)])]),e._v(" "),t("li",[e._v("EC2에서 작업을 수행하기 위해 "),t("strong",[t("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/getting-started-create-iam-instance-profile.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("S3 접근 권한이 있는 Role 생성"),t("OutboundLink")],1)]),e._v(" 후 EC2에 Role 할당")]),e._v(" "),t("li",[e._v("CodeDeploy 웹 콘솔에서 "),t("strong",[t("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/deployment-groups-create.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("배포 그룹 생성(ARN에서 기존에 생성한 CodeDeploy Role 선택)"),t("OutboundLink")],1)]),e._v(" 후 배포 애플리케이션 생성")])]),e._v(" "),t("h2",{attrs:{id:"appspec-yml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#appspec-yml"}},[e._v("#")]),e._v(" "),t("code",[e._v("appspec.yml")])]),e._v(" "),t("p",[t("a",{attrs:{href:"https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/reference-appspec-file.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/reference-appspec-file.html"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("최소 기능 스크립트 ("),t("code",[e._v("runas")]),e._v(" 사용시 사용자 암호 입력이 필요하다면 오류발생함)")]),e._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0.0")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("os")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" linux\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("files")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("source")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" ./\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("destination")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" /home/ec2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("user/deployment/\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("hooks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("BeforeInstall")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("location")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" scripts/deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("prepare.sh\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("runas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" ec2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("user\n "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("ApplicationStart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("location")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" scripts/deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("run.sh\n     "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("runas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" ec2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("user\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br"),t("span",{staticClass:"line-number"},[e._v("12")]),t("br")])]),t("ul",[t("li",[e._v("스크립트가 실행되는 경로는 Code Deploy Agent가 설치된 경로임 "),t("code",[e._v("/opt/codedeploy-agent")])]),e._v(" "),t("li",[e._v("실제 파일 경로는: "),t("code",[e._v("/opt/codedeploy-agent/deployment-root/{deployment-group-ID}/{deployment-ID}")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);